{"version":3,"file":"ra-auth-firebase.js","sources":["../src/auth-provider.js"],"sourcesContent":["import { AUTH_LOGIN, AUTH_LOGOUT, AUTH_CHECK, AUTH_GET_PERMISSIONS } from 'react-admin'\nimport firebase from 'firebase'\nimport deepAssign from 'deep-assign'\n\nconst baseConfig = {\n  admin: {\n    path: '/users/',\n    validate: () => true\n  },\n  keys: {\n    permissions: 'user',\n    token: 'firebase'\n  },\n  handleAuthStateChange: async (auth, config) => {\n    if (auth) {\n      const path = config.admin.path + auth.uid\n      const snapshot = await firebase.database().ref(path).once('value')\n      const profile = snapshot.val()\n\n      if (profile !== undefined && profile !== null && config.admin.validate(profile)) {\n        const firebaseToken = auth.getIdToken()\n        let user = { profile, firebaseToken }\n        localStorage.setItem(config.keys.token, firebaseToken)\n        localStorage.setItem(config.keys.permissions, JSON.stringify(profile))\n        return user\n      } else {\n        firebase.auth().signOut()\n        localStorage.removeItem(config.keys.token)\n        return Promise.reject(new Error('Oops! You don\\'t seem to be a authorized user'))\n      }\n    } else {\n      localStorage.removeItem(config.keys.token)\n    }\n  }\n}\n\nexport default (config = {}) => {\n  config = deepAssign({}, baseConfig, config)\n\n  const firebaseLoaded = () => new Promise(resolve => {\n    firebase.auth().onAuthStateChanged(resolve)\n  })\n\n  return async (type, params) => {\n    if (type === AUTH_LOGOUT) {\n      await config.handleAuthStateChange(null, config)\n      return firebase.auth().signOut()\n    }\n\n    if (firebase.auth().currentUser) {\n      await firebase.auth().currentUser.reload()\n    }\n\n    if (type === AUTH_CHECK) {\n      await firebaseLoaded()\n\n      if (!firebase.auth().currentUser) {\n        return Promise.reject(new Error('Oops! You don\\'t seem to be signed in.'))\n      }\n\n      return true\n    }\n\n    if (type === AUTH_LOGIN) {\n      const { username, password } = params\n      let auth = firebase.auth().currentUser\n\n      if (!auth) {\n        try {\n          auth = await firebase.auth().signInWithEmailAndPassword(username, password)\n        } catch (error) {\n          return Promise.reject(error)\n        }\n      }\n\n      return config.handleAuthStateChange(auth, config)\n    }\n\n    if (type === AUTH_GET_PERMISSIONS) {\n      const data = localStorage.getItem(config.keys.permissions)\n      return data ? Promise.resolve(JSON.parse(data)) : Promise.reject(new Error('Could not get permissions'))\n    }\n\n    return false\n  }\n}\n"],"names":["const","let","AUTH_LOGOUT","AUTH_CHECK","AUTH_LOGIN","AUTH_GET_PERMISSIONS"],"mappings":";;;;;;AAIAA,IAAM,aAAa;IACjB,OAAO;QACL,MAAM,SADD;QAEL,sBAAU,SAAM;KAHD;IAKjB,MAAM;QACJ,aAAa,MADT;QAEJ,OAAO;KAPQ;IASjB,iCAA8B,IAAM,EAAA,QAAb;QACrB,IAAI,MAAM;;YACF,OAAO,MAAA,CAAO,KAAP,CAAa,IAAb,GAAoB,IAAA,CAAK;YACrB,OAAM,QAAA,CAAS,QAAT,EAAA,CAAoB,GAApB,CAAwB,KAAxB,CAA8B,IAA9B,CAAmC,SAAzC;;oBAAX,WAAW;oBACX,UAAU,QAAA,CAAS,GAAT;oBAEhB,IAAI,OAAA,KAAY,SAAZ,IAAyB,OAAA,KAAY,IAArC,IAA6C,MAAA,CAAO,KAAP,CAAa,QAAb,CAAsB,UAAU;;wBACzE,gBAAgB,IAAA,CAAK,UAAL;wBACtBC,IAAI,OAAO;qCAAE,OAAF;2CAAW;;wBACtB,YAAA,CAAa,OAAb,CAAqB,MAAA,CAAO,IAAP,CAAY,OAAO;wBACxC,YAAA,CAAa,OAAb,CAAqB,MAAA,CAAO,IAAP,CAAY,aAAa,IAAA,CAAK,SAAL,CAAe;wBAC7D,eAAO;2BACF;wBACL,QAAA,CAAS,IAAT,EAAA,CAAgB,OAAhB;wBACA,YAAA,CAAa,UAAb,CAAwB,MAAA,CAAO,IAAP,CAAY;wBACpC,eAAO,OAAA,CAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU;;;;;;;eAE7B;YACL,YAAA,CAAa,UAAb,CAAwB,MAAA,CAAO,IAAP,CAAY;;;;;;;;;AAK1C,uBAAgB,QAAD;mCAAC,GAAS;;IACvB,MAAA,GAAS,UAAA,CAAW,IAAI,YAAY;IAEpCD,IAAM,6BAAiB,SAAM,IAAI,OAAJ,WAAY;QACvC,QAAA,CAAS,IAAT,EAAA,CAAgB,kBAAhB,CAAmC;;IAGrC,iBAAc,IAAM,EAAA,QAAb;QACL,IAAI,IAAA,KAASE,wBAAa;YACxB,OAAM,MAAA,CAAO,qBAAP,CAA6B,MAAM,QAAzC;;oBACA,eAAO,QAAA,CAAS,IAAT,EAAA,CAAgB,OAAhB;;;;;;QAGT,IAAI,QAAA,CAAS,IAAT,EAAA,CAAgB,aAAa;YAC/B,OAAM,QAAA,CAAS,IAAT,EAAA,CAAgB,WAAhB,CAA4B,MAA5B,GAAN;;;;;;;;;;;YAGF,IAAI,IAAA,KAASC,uBAAY;gBACvB,OAAM,cAAA,GAAN;;wBAEA,IAAI,CAAC,QAAA,CAAS,IAAT,EAAA,CAAgB,aAAa;4BAChC,eAAO,OAAA,CAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU;;wBAGlC,eAAO;;;;;;YAGT,IAAI,IAAA,KAASC,uBAAY;;2BACQ,QAAvB,4BAAU;gBACd,OAAO,QAAA,CAAS,IAAT,EAAA,CAAgB;gBAE3B,IAAI,CAAC,MAAM;;;;;;;;iDAGA,OAAO;;4BACd,eAAO,OAAA,CAAQ,MAAR,CAAe;;;;;oBAHxB,IAAI;wBACK,OAAM,QAAA,CAAS,IAAT,EAAA,CAAgB,0BAAhB,CAA2C,UAAU,UAA3D;;gCAAP,IAAA,GAAO;;;;;;qBACP,QAAO,OAAO;qCAAP;;;;oBAKX,eAAO,MAAA,CAAO,qBAAP,CAA6B,MAAM;;;;;;YAG5C,IAAI,IAAA,KAASC,iCAAsB;;gBAC3B,OAAO,YAAA,CAAa,OAAb,CAAqB,MAAA,CAAO,IAAP,CAAY;gBAC9C,eAAO,IAAA,GAAO,OAAA,CAAQ,OAAR,CAAgB,IAAA,CAAK,KAAL,CAAW,SAAS,OAAA,CAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU;;YAG7E,eAAO;;;;;;;;;"}