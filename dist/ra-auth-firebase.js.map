{"version":3,"file":"ra-auth-firebase.js","sources":["../src/auth-provider.js"],"sourcesContent":["import { AUTH_LOGIN, AUTH_LOGOUT, AUTH_CHECK, AUTH_GET_PERMISSIONS } from 'react-admin'\nimport firebase from 'firebase'\nimport deepAssign from 'deep-assign'\n\nconst baseConfig = {\n  admin: {\n    path: '/users/',\n    validate: () => true\n  },\n  keys: {\n    permissions: 'user',\n    token: 'firebase'\n  },\n  handleAuthStateChange: async (auth, config) => {\n    if (auth) {\n      const path = config.admin.path + auth.uid\n      const snapshot = await firebase.database().ref(path).once('value')\n      const profile = snapshot.val()\n\n      if (profile !== undefined && profile !== null && config.admin.validate(profile)) {\n        const firebaseToken = auth.getIdToken()\n        let user = { profile, firebaseToken }\n        localStorage.setItem(config.keys.token, firebaseToken)\n        localStorage.setItem(config.keys.permissions, JSON.stringify(profile))\n        return user\n      } else {\n        firebase.auth().signOut()\n        localStorage.removeItem(config.keys.token)\n        return Promise.reject(new Error('Oops! You don\\'t seem to be a authorized user'))\n      }\n    } else {\n      localStorage.removeItem(config.keys.token)\n    }\n  }\n}\n\nexport default (config = {}) => {\n  config = deepAssign({}, baseConfig, config)\n\n  const firebaseLoaded = () => new Promise(resolve => {\n    firebase.auth().onAuthStateChanged(resolve)\n  })\n\n  return async (type, params) => {\n    if (type === AUTH_LOGOUT) {\n      await config.handleAuthStateChange(null, config)\n      return firebase.auth().signOut()\n    }\n\n    if (firebase.auth().currentUser) {\n      await firebase.auth().currentUser.reload()\n    }\n\n    if (type === AUTH_CHECK) {\n      await firebaseLoaded()\n\n      if (!firebase.auth().currentUser) {\n        return Promise.reject(new Error('Oops! You don\\'t seem to be signed in.'))\n      }\n\n      return true\n    }\n\n    if (type === AUTH_LOGIN) {\n      const { username, password } = params\n      let auth = firebase.auth().currentUser\n\n      if (!auth) {\n        try {\n          auth = await firebase.auth().signInWithEmailAndPassword(username, password)\n        } catch (error) {\n          return Promise.reject(error)\n        }\n      }\n\n      return config.handleAuthStateChange(auth, config)\n    }\n\n    if (type === AUTH_GET_PERMISSIONS) {\n      const data = localStorage.getItem(config.keys.permissions)\n      return data ? Promise.resolve(JSON.parse(data)) : Promise.reject(new Error('Could not get permissions'))\n    }\n\n    return false\n  }\n}\n"],"names":["baseConfig","admin","path","validate","keys","permissions","token","handleAuthStateChange","auth","config","uid","firebase","database","ref","once","then","undefined","profile","$await_8","val","firebaseToken","getIdToken","let","user","localStorage","setItem","JSON","stringify","signOut","removeItem","Promise","reject","Error","deepAssign","const","firebaseLoaded","resolve","onAuthStateChanged","type","params","AUTH_LOGOUT","currentUser","reload","AUTH_CHECK","AUTH_LOGIN","username","password","error","signInWithEmailAndPassword","$await_12","AUTH_GET_PERMISSIONS","data","getItem","parse"],"mappings":"wJAIMA,GACJC,OACEC,KAAM,UACNC,2BAAgB,IAElBC,MACEC,YAAa,OACbC,MAAO,YAETC,+BAA8BC,EAAMC,4CAClC,OAAID,GACIN,EAAOO,EAAOR,MAAMC,KAAOM,EAAKE,IACfC,EAASC,WAAWC,IAAIX,GAAMY,KAAK,SAAzCC,qBAGjB,QAAgBC,KAFVC,EADWC,EACQC,QAEgB,OAAZF,GAAoBR,EAAOR,MAAME,SAASc,GAAU,OACzEG,EAAgBZ,EAAKa,aAC3BC,IAAIC,WAASN,gBAASG,GAGtB,OAFAI,aAAaC,QAAQhB,EAAOL,KAAKE,MAAOc,GACxCI,aAAaC,QAAQhB,EAAOL,KAAKC,YAAaqB,KAAKC,UAAUV,MACtDM,GAIP,OAFAZ,EAASH,OAAOoB,UAChBJ,aAAaK,WAAWpB,EAAOL,KAAKE,SAC7BwB,QAAQC,OAAO,IAAIC,MAAM,yFAGlCR,aAAaK,WAAWpB,EAAOL,KAAKE,+EAK1C,SAAgBG,sBACdA,EAASwB,KAAejC,EAAYS,GAEpCyB,IAAMC,oBAAuB,IAAIL,iBAAQM,GACvCzB,EAASH,OAAO6B,mBAAmBD,MAGrC,gBAAcE,EAAMC,oCAClB,GAAID,IAASE,cACX,OAAM/B,EAAOF,sBAAsB,KAAME,GAAzCM,qBACA,SAAOJ,EAASH,OAAOoB,qCAGzB,GAAIjB,EAASH,OAAOiC,YAClB,OAAM9B,EAASH,OAAOiC,YAAYC,SAAlC3B,mGAGF,GAAIuB,IAASK,aACX,OAAMR,IAANpB,qBAEA,OAAKJ,EAASH,OAAOiC,eAId,KAHEX,QAAQC,OAAO,IAAIC,MAAM,qEAMpC,GAAIM,IAASM,aAAY,WAIvB,GAHQC,KAAuBN,YAAbO,eACdtC,EAAOG,EAASH,OAAOiC,aAEhB,uFAGAM,OACP,SAAOjB,QAAQC,OAAOgB,2BAHxB,IACS,OAAMpC,EAASH,OAAOwC,2BAA2BH,EAAUC,GAA3D/B,4BAAPP,EAAOyC,sCACAF,KAAAA,iBAKX,SAAOtC,EAAOF,sBAAsBC,EAAMC,wBAG5C,OAAI6B,IAASY,wBACLC,EAAO3B,aAAa4B,QAAQ3C,EAAOL,KAAKC,eACvC8C,EAAOrB,QAAQM,QAAQV,KAAK2B,MAAMF,IAASrB,QAAQC,OAAO,IAAIC,MAAM,mCAGtE"}