!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react-admin"),require("firebase"),require("deep-assign")):"function"==typeof define&&define.amd?define(["exports","react-admin","firebase","deep-assign"],t):t(e.raAuthFirebase={},null,e.firebase,null)}(this,function(e,t,r,n){r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n;var u={admin:{path:"/users/",validate:function(){return!0}},keys:{permissions:"user",token:"firebase"},handleAuthStateChange:function(e,t){return new Promise(function(n,u){var a,i;return e?(a=t.admin.path+e.uid,r.database().ref(a).once("value").then(function(a){try{if(void 0!==(i=a.val())&&null!==i&&t.admin.validate(i)){var o;o=e.getIdToken();var s={profile:i,firebaseToken:o};return localStorage.setItem(t.keys.token,o),localStorage.setItem(t.keys.permissions,JSON.stringify(i)),n(s)}return r.auth().signOut(),localStorage.removeItem(t.keys.token),n(Promise.reject(new Error("Oops! You don't seem to be a authorized user")))}catch(e){return u(e)}}.bind(this),u)):(localStorage.removeItem(t.keys.token),o.call(this));function o(){return n()}})}};e.FirebaseAuthProvider=function(e){void 0===e&&(e={}),e=n({},u,e);var a=function(){return new Promise(function(e){r.auth().onAuthStateChanged(e)})};return function(n,u){return new Promise(function(i,o){if(n===t.AUTH_LOGOUT)return e.handleAuthStateChange(null,e).then(function(e){try{return i(r.auth().signOut())}catch(e){return o(e)}},o);if(r.auth().currentUser)return r.auth().currentUser.reload().then(function(e){try{return s.call(this)}catch(e){return o(e)}}.bind(this),o);function s(){var s,c;if(n===t.AUTH_CHECK)return a().then(function(e){try{return r.auth().currentUser?i(!0):i(Promise.reject(new Error("Oops! You don't seem to be signed in.")))}catch(e){return o(e)}},o);if(n===t.AUTH_LOGIN){var h,f,l;if(h=(s=u).username,f=s.password,!(l=r.auth().currentUser)){var d=function(){try{return p.call(this)}catch(e){return o(e)}}.bind(this),m=function(e){try{return i(Promise.reject(e))}catch(e){return o(e)}};try{return r.auth().signInWithEmailAndPassword(h,f).then(function(e){try{return l=e,d()}catch(e){return m(e)}},m)}catch(e){m(e)}}function p(){return i(e.handleAuthStateChange(l,e))}return p.call(this)}return n===t.AUTH_GET_PERMISSIONS?(c=localStorage.getItem(e.keys.permissions),i(c?Promise.resolve(JSON.parse(c)):Promise.reject(new Error("Could not get permissions")))):i(!1)}return s.call(this)})}}});
//# sourceMappingURL=ra-auth-firebase.umd.js.map
