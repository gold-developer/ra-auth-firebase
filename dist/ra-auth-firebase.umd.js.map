{"version":3,"file":"ra-auth-firebase.umd.js","sources":["../src/auth-provider.js"],"sourcesContent":["import { AUTH_LOGIN, AUTH_LOGOUT, AUTH_CHECK, AUTH_GET_PERMISSIONS } from 'react-admin'\nimport firebase from 'firebase'\nimport deepAssign from 'deep-assign'\n\nconst baseConfig = {\n  admin: {\n    path: '/users/',\n    validate: () => true\n  },\n  keys: {\n    permissions: 'user',\n    token: 'firebase'\n  },\n  handleAuthStateChange: async (auth, config) => {\n    if (auth) {\n      const path = config.admin.path + auth.uid\n      const snapshot = await firebase.database().ref(path).once('value')\n      const profile = snapshot.val()\n\n      if (profile !== undefined && profile !== null && config.admin.validate(profile)) {\n        const firebaseToken = auth.getIdToken()\n        let user = { profile, firebaseToken }\n        localStorage.setItem(config.keys.token, firebaseToken)\n        localStorage.setItem(config.keys.permissions, JSON.stringify(profile))\n        return user\n      } else {\n        firebase.auth().signOut()\n        localStorage.removeItem(config.keys.token)\n        return Promise.reject(new Error('Oops! You don\\'t seem to be a authorized user'))\n      }\n    } else {\n      localStorage.removeItem(config.keys.token)\n    }\n  }\n}\n\nexport default (config = {}) => {\n  config = deepAssign({}, baseConfig, config)\n\n  const firebaseLoaded = () => new Promise(resolve => {\n    firebase.auth().onAuthStateChanged(resolve)\n  })\n\n  return async (type, params) => {\n    if (type === AUTH_LOGOUT) {\n      await config.handleAuthStateChange(null, config)\n      return firebase.auth().signOut()\n    }\n\n    if (firebase.auth().currentUser) {\n      await firebase.auth().currentUser.reload()\n    }\n\n    if (type === AUTH_CHECK) {\n      await firebaseLoaded()\n\n      if (!firebase.auth().currentUser) {\n        return Promise.reject(new Error('Oops! You don\\'t seem to be signed in.'))\n      }\n\n      return true\n    }\n\n    if (type === AUTH_LOGIN) {\n      const { username, password } = params\n      let auth = firebase.auth().currentUser\n\n      if (!auth) {\n        try {\n          auth = await firebase.auth().signInWithEmailAndPassword(username, password)\n        } catch (error) {\n          return Promise.reject(error)\n        }\n      }\n\n      return config.handleAuthStateChange(auth, config)\n    }\n\n    if (type === AUTH_GET_PERMISSIONS) {\n      const data = localStorage.getItem(config.keys.permissions)\n      return data ? Promise.resolve(JSON.parse(data)) : Promise.reject(new Error('Could not get permissions'))\n    }\n\n    return false\n  }\n}\n"],"names":["const","let","AUTH_LOGOUT","AUTH_CHECK","AUTH_LOGIN","AUTH_GET_PERMISSIONS"],"mappings":";;;;;;;;EAIAA,IAAM,aAAa;MACjB,OAAO;UACL,MAAM,SADD;UAEL,sBAAU,SAAM;OAHD;MAKjB,MAAM;UACJ,aAAa,MADT;UAEJ,OAAO;OAPQ;MASjB,iCAA8B,IAAM,EAAA,QAAb;UACrB,IAAI,MAAM;;cACF,OAAO,MAAA,CAAO,KAAP,CAAa,IAAb,GAAoB,IAAA,CAAK;cACrB,OAAM,QAAA,CAAS,QAAT,EAAA,CAAoB,GAApB,CAAwB,KAAxB,CAA8B,IAA9B,CAAmC,SAAzC;;sBAAX,WAAW;sBACX,UAAU,QAAA,CAAS,GAAT;sBAEhB,IAAI,OAAA,KAAY,SAAZ,IAAyB,OAAA,KAAY,IAArC,IAA6C,MAAA,CAAO,KAAP,CAAa,QAAb,CAAsB,UAAU;;0BACzE,gBAAgB,IAAA,CAAK,UAAL;0BACtBC,IAAI,OAAO;uCAAE,OAAF;6CAAW;;0BACtB,YAAA,CAAa,OAAb,CAAqB,MAAA,CAAO,IAAP,CAAY,OAAO;0BACxC,YAAA,CAAa,OAAb,CAAqB,MAAA,CAAO,IAAP,CAAY,aAAa,IAAA,CAAK,SAAL,CAAe;0BAC7D,eAAO;6BACF;0BACL,QAAA,CAAS,IAAT,EAAA,CAAgB,OAAhB;0BACA,YAAA,CAAa,UAAb,CAAwB,MAAA,CAAO,IAAP,CAAY;0BACpC,eAAO,OAAA,CAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU;;;;;;;iBAE7B;cACL,YAAA,CAAa,UAAb,CAAwB,MAAA,CAAO,IAAP,CAAY;;;;;;;;;AAK1C,yBAAgB,QAAD;qCAAC,GAAS;;MACvB,MAAA,GAAS,UAAA,CAAW,IAAI,YAAY;MAEpCD,IAAM,6BAAiB,SAAM,IAAI,OAAJ,WAAY;UACvC,QAAA,CAAS,IAAT,EAAA,CAAgB,kBAAhB,CAAmC;;MAGrC,iBAAc,IAAM,EAAA,QAAb;UACL,IAAI,IAAA,KAASE,wBAAa;cACxB,OAAM,MAAA,CAAO,qBAAP,CAA6B,MAAM,QAAzC;;sBACA,eAAO,QAAA,CAAS,IAAT,EAAA,CAAgB,OAAhB;;;;;;UAGT,IAAI,QAAA,CAAS,IAAT,EAAA,CAAgB,aAAa;cAC/B,OAAM,QAAA,CAAS,IAAT,EAAA,CAAgB,WAAhB,CAA4B,MAA5B,GAAN;;;;;;;;;;;cAGF,IAAI,IAAA,KAASC,uBAAY;kBACvB,OAAM,cAAA,GAAN;;0BAEA,IAAI,CAAC,QAAA,CAAS,IAAT,EAAA,CAAgB,aAAa;8BAChC,eAAO,OAAA,CAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU;;0BAGlC,eAAO;;;;;;cAGT,IAAI,IAAA,KAASC,uBAAY;;6BACQ,QAAvB,4BAAU;kBACd,OAAO,QAAA,CAAS,IAAT,EAAA,CAAgB;kBAE3B,IAAI,CAAC,MAAM;;;;;;;;mDAGA,OAAO;;8BACd,eAAO,OAAA,CAAQ,MAAR,CAAe;;;;;sBAHxB,IAAI;0BACK,OAAM,QAAA,CAAS,IAAT,EAAA,CAAgB,0BAAhB,CAA2C,UAAU,UAA3D;;kCAAP,IAAA,GAAO;;;;;;uBACP,QAAO,OAAO;uCAAP;;;;sBAKX,eAAO,MAAA,CAAO,qBAAP,CAA6B,MAAM;;;;;;cAG5C,IAAI,IAAA,KAASC,iCAAsB;;kBAC3B,OAAO,YAAA,CAAa,OAAb,CAAqB,MAAA,CAAO,IAAP,CAAY;kBAC9C,eAAO,IAAA,GAAO,OAAA,CAAQ,OAAR,CAAgB,IAAA,CAAK,KAAL,CAAW,SAAS,OAAA,CAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU;;cAG7E,eAAO;;;;;;;;;;;;;;;;;;"}